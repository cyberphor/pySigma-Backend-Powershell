![License](https://img.shields.io/github/license/cyberphor/pySigma-backend-powershell?color=Green)
![Status](https://img.shields.io/badge/Status-pre--release-orange)
![Tests](https://github.com/cyberphor/pySigma-backend-powershell/actions/workflows/test.yml/badge.svg)

# pySigma PowerShell Backend
PowerShell pipeline and backend packages for the pySigma Python library. 

## Overview
The `sigma.pipelines.powershell` package maps Sigma rules to Windows event log and PowerShell characteristics using the `powershell_pipeline`. The `sigma.backends.powershell` package and `PowerShellBackend` class generate PowerShell queries using the output of the `powershell_pipeline`. The `PowerShellBackend` class supports the following output formats: plain PowerShell queries (default). 

## Usage
Use the `sigma2powershell.py` Python script to convert Sigma rules into PowerShell queries using the backend and pipeline provided by this GitHub repository. See below for an example. 

**Step 1.** Run the `sigma2powershell.py` Python script using the file-path of a Sigmal rule as an argument. 
```
python .\sigma2powershell.py --rule-file .\rules\03-TA0002-Execution\T1059.001-PowerShell\download-via-powershell.yml
```

**Step 2.** Copy/paste the query generated by `sigma2powershell.py` into PowerShell. NOTE: you must import the `Read-WinEvent.psm1` PowerShell module to leverage the `Read-WinEvent` cmdlet. You only need to import this module once during a PowerShell session. You do NOT need to import every time you are going to execute a PowerShell query during said session. 
```pwsh
Import-Module .\Read-WinEvent.psm1
Get-WinEvent -FilterHashTable @{LogName="Security";Id=4624} | 
Read-WinEvent | 
Where-Object { ($_.LogonType  -in  (2, 3, 10)) } | 
Select-Object -Property TimeCreated, TargetUserName, LogonType
```

**Step 3.** Analyze the output for suspicious activity. 
```
TimeCreated         TargetUserName LogonType
-----------         -------------- ---------
2022-07-27 05:18:28 Victor         2        
2022-07-27 05:18:28 Victor         2        
2022-07-26 09:32:38 DWM-13         2        
2022-07-26 09:32:38 DWM-13         2        
2022-07-26 09:32:38 UMFD-13        2        
2022-07-26 09:24:01 AcidBurn       10        
2022-07-26 09:24:01 AcidBurn       10  
```

## Related Projects
For data sets to test the pySigma PowerShell backend, consider checking out [EVTX-MITRE-Attack](https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack).
```
git clone https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack
```
```
Get-WinEvent -Path $PathToEvtxLogs 
```

## Maintainers
This project is currently maintained by: [Victor Fernandez III](https://github.com/cyberphor/)